let user = null;

function toggleAuth(section) {
  document.getElementById('register').style.display = 'none';
  document.getElementById('login').style.display = 'none';
  document.getElementById('recovery').style.display = 'none';
  document.getElementById(section).style.display = 'block';
}

function register() {
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const security = document.getElementById('reg-security').value.trim();

  if (localStorage.getItem(`user-${email}`)) {
    alert('Email already registered.');
    return;
  }

  const newUser = {
    username,
    email,
    password,
    security,
    stats: { wins: 0, losses: 0, total: 0 },
    games: [],
  };

  localStorage.setItem(`user-${email}`, JSON.stringify(newUser));
  alert('Registered successfully!');
  toggleAuth('login');
}

function login() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;

  const stored = localStorage.getItem(`user-${email}`);
  if (!stored) return alert('No account found.');

  const userData = JSON.parse(stored);
  if (userData.password !== password) return alert('Incorrect password.');

  localStorage.setItem('loggedIn', email);
  user = userData;
  initApp();
}

function recover() {
  const email = document.getElementById('recover-email').value.trim();
  const security = document.getElementById('recover-security').value.trim();
  const stored = localStorage.getItem(`user-${email}`);
  if (!stored) return alert('No account found.');

  const userData = JSON.parse(stored);
  if (userData.security.toLowerCase() === security.toLowerCase()) {
    alert(`Username: ${userData.username}\nPassword: ${userData.password}`);
  } else {
    alert('Incorrect recovery answer.');
  }
}

function logout() {
  localStorage.removeItem('loggedIn');
  location.reload();
}

function initApp() {
  document.getElementById('auth').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('dashboard-view').classList.add('active');
  document.getElementById('user-welcome').innerText = `Welcome, ${user.username}!`;
  loadUserData();
}

document.querySelectorAll('.nav button').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(`${btn.dataset.view}-view`).classList.add('active');
    if (btn.dataset.view === 'stats') {
      updateStatsChart();
      updateGamesChart();
    }
  };
});

function getUserData() {
  const stored = localStorage.getItem(`user-${user.email}`);
  return JSON.parse(stored);
}

function saveUserData(data) {
  localStorage.setItem(`user-${user.email}`, JSON.stringify(data));
}

function loadUserData() {
  const list = document.getElementById('game-list');
  list.innerHTML = '';
  user.games.forEach(game => {
    const li = document.createElement('li');
    li.textContent = `${game.opponent} | ${game.gameType} | Race to ${game.raceTo} | ${game.won ? 'Win' : 'Loss'} | ${game.date}`;
    list.appendChild(li);
  });
}

document.getElementById('game-form').onsubmit = e => {
  e.preventDefault();
  const game = {
    opponent: document.getElementById('opponent').value,
    gameType: document.getElementById('gameType').value,
    raceTo: parseInt(document.getElementById('raceTo').value),
    date: document.getElementById('dateTime').value,
    won: document.getElementById('won').value === 'true',
  };
  user.games.push(game);
  if (game.won) user.stats.wins++;
  else user.stats.losses++;
  user.stats.total++;
  saveUserData(user);
  loadUserData();
  e.target.reset();
};

document.getElementById('reset-data').onclick = () => {
  if (confirm('Reset all records?')) {
    user.stats = { wins: 0, losses: 0, total: 0 };
    user.games = [];
    saveUserData(user);
    loadUserData();
  }
};

document.getElementById('load-data').onclick = () => {
  user = getUserData();
  loadUserData();
};

function updateStatsChart() {
  const ctx = document.getElementById('statsChart').getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Wins', 'Losses'],
      datasets: [{
        data: [user.stats.wins, user.stats.losses],
        backgroundColor: ['green', 'red']
      }]
    }
  });
}

function updateGamesChart() {
  const ctx = document.getElementById('gamesChart').getContext('2d');
  const total = user.stats.total || 1;
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Win %'],
      datasets: [{
        label: 'Win %',
        data: [((user.stats.wins / total) * 100).toFixed(1)],
        backgroundColor: 'blue'
      }]
    }
  });
}

function initMap() {
  const loc = document.getElementById('map-location').value;
  const geocoder = new google.maps.Geocoder();
  geocoder.geocode({ address: loc }, (res, status) => {
    if (status === 'OK') {
      const map = new google.maps.Map(document.getElementById('map'), {
        center: res[0].geometry.location,
        zoom: 12
      });
      const service = new google.maps.places.PlacesService(map);
      service.nearbySearch({
        location: res[0].geometry.location,
        radius: 5000,
        keyword: 'pool hall'
      }, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          results.forEach(place => {
            new google.maps.Marker({
              map,
              position: place.geometry.location,
              title: place.name
            });
          });
        }
      });
    } else {
      alert('Geocode failed: ' + status);
    }
  });
}

// Auto-login
window.onload = () => {
  const email = localStorage.getItem('loggedIn');
  if (email && localStorage.getItem(`user-${email}`)) {
    user = JSON.parse(localStorage.getItem(`user-${email}`));
    initApp();
  }
};
